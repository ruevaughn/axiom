{
  "builders": [
    {
      "type": "digitalocean",
      "ssh_username": "root",
      "snapshot_name": "{{ user `snapshot_name` }}",
      "api_token": "{{ user `do_key` }}",
      "image": "ubuntu-20-04-x64",
      "region": "{{ user `region`  }}",
      "size": "s-1vcpu-1gb"
    }
  ],
  "provisioners": [
    {
      "type": "file",
      "source": "./configs",
      "destination":"/tmp/configs"
    },
    {
      "execute_command": "chmod +x {{ .Path }}; {{ .Vars }} sudo -E sh '{{ .Path }}'",
      "inline": [
        "echo 'Waiting for cloud-init to finish, this can take a few minutes please be patient...'",
        "/bin/su -l root -c 'DEBIAN_FRONTEND=noninteractive apt-get update -y'",
        "sudo apt-get install net-tools zsh zsh-syntax-highlighting zsh-autosuggestions",
        "useradd -G sudo -s /bin/bash -m op",
        "/bin/su -l op -c '/bin/bash -c \"$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)\"'",
        "sudo apt-get install build-essential",
        "mkdir -p /home/op/.ssh /home/op/c2 /home/op/lists /home/op/bin /home/op/.config/ /home/op/work/ /home/op/.config/amass",
        "chown -R op:users /home/op",
        "echo 'op:{{ user `op_random_password` }}' | chpasswd",
        "echo 'root:{{ user `op_random_password` }}' | chpasswd",
        "chown -R op:users /home/op",
        "echo 'Installing homebrew'",
        "/bin/su -l root -c 'mkdir -p /home/linuxbrew/.linuxbrew && chown -R op:op /home/linuxbrew/.linuxbrew'",
        "/bin/su -l op -c '/bin/bash -c \"$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)\"'",
        "(echo; echo 'eval \"$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)\"') >> /home/op/.profile",
        "eval \"$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)\"",
        "/bin/su -l op -c 'brew install anyenv'",
        "/bin/su -l op -c 'yes | anyenv install --init'",
        "/bin/su -l op -c 'echo export PATH=\"$HOME/.anyenv/bin:$PATH\" >> ~/.zshrc'",
        "/bin/su -l op -c 'echo 'eval \"$(anyenv init -)\" >> ~/.zshrc''",
        "/bin/su -l op -c 'anyenv install pyenv'",
        "/bin/su -l op -c 'anyenv install nodenv'", 
        "/bin/su -l op -c 'anyenv install rbenv'", 
        "/bin/su -l op -c 'anyenv install phpenv'", 
        "/bin/su -l op -c 'anyenv install goenv'", 
        "/bin/su -l op -c 'exec $SHELL -l'",
        "mkdir -p $(anyenv root)/plugins",
        "git clone https://github.com/znz/anyenv-update.git $(anyenv root)/plugins/anyenv-update",
        "exec $SHELL -l",
        "anyenv update" ,
        "goenv install 1.21.1 && goenv global 1.21.1",
        "pyenv install 3.9.18 && pyenv global 3.9.18",
        "rbenv install 3.2.2 && rbenv global 3.2.2",
        "nodenv install rc && nodenv global rc",
        "/bin/su -l op -c 'curl https://sh.rustup.rs -sSf | sh'",

        "echo \"The password for user op is: {{ user `op_random_password` }}\"",
        "echo \"CgpDb25ncmF0dWxhdGlvbnMsIHlvdXIgYnVpbGQgaXMgYWxtb3N0IGRvbmUhCgogICAgICAgICAgICAgYXhpb20gaXMgc3BvbnNvcmVkIGJ5Li4uCl9fX18gICAgICAgICAgICAgICAgICAgICAgIF8gXyAgICAgICAgX19fX18uICAgICAgICAgXyBfCi8gX19ffCAgX19fICBfX18gXyAgIF8gXyBfXyhfKSB8XyBfICAgfF8gICBffCBfXyBfXyBfKF8pIHxfX18KXF9fXyBcIC8gXyBcLyBfX3wgfCB8IHwgJ19ffCB8IF9ffCB8IHwgfHwgfHwgJ19fLyBfYCB8IHwgLyBfX3wKIF9fXykgfCAgX18vIChfX3wgfF98IHwgfCAgfCB8IHxffCB8X3wgfHwgfHwgfCB8IChffCB8IHwgXF9fIFwKfF9fX18vIFxfX198XF9fX3xcX18sX3xffCAgfF98XF9ffFxfXywgfHxffHxffCAgXF9fLF98X3xffF9fXy8KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHxfX18vCgpSZWFkIHRoZXNlIHdoaWxlIHlvdSdyZSB3YWl0aW5nIHRvIGdldCBzdGFydGVkIDopCgogICAgLSBRdWlja3N0YXJ0IEd1aWRlOiBodHRwczovL2dpdGh1Yi5jb20vcHJ5MGNjL2F4aW9tL3dpa2kvQS1RdWlja3N0YXJ0LUd1aWRlCiAgICAtIENoZWF0c2hlZXQ6IGh0dHBzOi8vZ2l0aHViLmNvbS9wcnkwY2MvYXhpb20vd2lraS9DaGVhdHNoZWV0CiAgICAtIEZsZWV0czogaHR0cHM6Ly9naXRodWIuY29tL3ByeTBjYy9heGlvbS93aWtpL0ZsZWV0cyAgICAgCiAgICAtIFNjYW5zOiBodHRwczovL2dpdGh1Yi5jb20vcHJ5MGNjL2F4aW9tL3dpa2kvU2NhbnMKCgo=\" | base64 -d",
        "touch /home/op/.profile",
        "touch /home/op/.z",
        "chown -R op:users /home/op",
        "chmod +x /etc/update-motd.d/00-header",
        "chown root:root /etc/sudoers /etc/sudoers.d -R",
        "mv /tmp/configs/authorized_keys /home/op/.ssh/authorized_keys",
        "mv /tmp/configs/sshd_config /etc/ssh/sshd_config",
        "/bin/su -l op -c 'sudo chmod 600 /home/op/.ssh/authorized_keys'",
        "sudo service sshd restart",

        "echo 'Optimizing SSH Connections'",
        "/bin/su -l root -c 'echo \"ClientAliveInterval 60\" | sudo tee -a /etc/ssh/sshd_config'",
        "/bin/su -l root -c 'echo \"ClientAliveCountMax 60\" | sudo tee -a /etc/ssh/sshd_config'",
        "/bin/su -l root -c 'echo \"MaxSessions 100\" | sudo tee -a /etc/ssh/sshd_config'",
        "/bin/su -l root -c 'echo \"net.ipv4.netfilter.ip_conntrack_max = 1048576\" | sudo tee -a /etc/sysctl.conf'",
        "/bin/su -l root -c 'echo \"net.nf_conntrack_max = 1048576\" | sudo tee -a /etc/sysctl.conf'",
        "/bin/su -l root -c 'echo \"net.core.somaxconn = 1048576\" | sudo tee -a /etc/sysctl.conf'",
        "/bin/su -l root -c 'echo \"net.ipv4.ip_local_port_range = 1024 65535\" | sudo tee -a /etc/sysctl.conf'",
        "/bin/su -l root -c 'echo \"1024 65535\" | sudo tee -a /proc/sys/net/ipv4/ip_local_port_range'"
      ], "inline_shebang": "/bin/sh -x",
	  "type": "shell"
    }
  ]
}
