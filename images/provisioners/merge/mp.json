{
  "builders": [],
  "provisioners": [
    {
      "type": "file",
      "source": "./configs",
      "destination":"/tmp/configs"
    },
    {
      "execute_command": "chmod +x {{ .Path }}; {{ .Vars }} sudo -E sh '{{ .Path }}'",
      "inline": [
        "echo '<>-------- provisioner: mp'",
        "export TERM=xterm",
        "echo 'Waiting for cloud-init to finish, this can take a few minutes please be patient...'",
        "/usr/bin/cloud-init status --wait",

        "fallocate -l 2G /swap && chmod 600 /swap && mkswap /swap && swapon /swap",
        "echo '/swap none swap sw 0 0' | sudo tee -a /etc/fstab",

        "echo 'Running dist-uprade'",
        "sudo apt-get update -y -qq",
        "DEBIAN_FRONTEND=noninteractive apt-get -o Dpkg::Options::=--force-confdef -o Dpkg::Options::=--force-confnew dist-upgrade -qq",

        "echo 'Net Tools, ZSH, gcc, and other packages'",
        "sudo apt-get -y install net-tools zsh build-essential",

        "echo 'Creating OP user'",
        "useradd -G sudo -s /usr/bin/zsh -m op",
        "mkdir -p /home/op/.ssh /home/op/c2 /home/op/recon/ /home/op/lists /home/op/go /home/op/bin /home/op/.config/ /home/op/.cache /home/op/work/ /home/op/.config/amass",
        "chown -R op:users /home/op",
        "echo 'op:{{ user `op_random_password` }}' | chpasswd",
        "echo 'root:{{ user `op_random_password` }}' | chpasswd",

        "echo 'installing oh-my-zsh'",
        "/bin/su -l op -c 'wget -q https://raw.github.com/ohmyzsh/ohmyzsh/master/tools/install.sh -O - | sh'",

        "echo 'Moving Config files'",
        "mv /tmp/configs/sudoers /etc/sudoers",
        "pkexec chown root:root /etc/sudoers /etc/sudoers.d -R",
        "mv /tmp/configs/zshrc /home/op/.zshrc",
        "mv /tmp/configs/sshd_config /etc/ssh/sshd_config",
        "mv /tmp/configs/00-header /etc/update-motd.d/00-header",
        "mv /tmp/configs/authorized_keys /home/op/.ssh/authorized_keys",
        "mv /tmp/configs/config.ini /home/op/.config/amass/config.ini",
        "mv /tmp/configs/tmux-splash.sh /home/op/bin/tmux-splash.sh",
        "/bin/su -l op -c 'sudo chmod 600 /home/op/.ssh/authorized_keys'",
        "echo 'Installing homebrew'",
        "/bin/su -l root -c 'mkdir -p /home/linuxbrew/.linuxbrew && chown -R op:op /home/linuxbrew/.linuxbrew'",
        "/bin/su -l op -c '/bin/bash -c \"$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)\"'",
        "(echo; echo 'eval \"$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)\"') >> /home/op/.zprofile",
        "eval \"$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)\"",
        "chown -R op:users /home/op",
        "echo 'Installing anyenv'",
        "/bin/su -l op -c 'brew install anyenv'",
        "export ANYENV_DEFINITION_ROOT=\"/home/op/.config/anyenv/anyenv-install\"",
        "echo 'Running anyenv init'",
        "/bin/su -l op -c 'yes | anyenv install --init'",
        "echo ran anyenv install --init",
        "echo 'export PATH=\"$HOME/.anyenv/bin:$PATH\"' >> /home/op/.zshrc",
        "echo 'eval \"$(anyenv init -)\"' >> /home/op/.zshrc",
        "export PATH=\"/home/op/.anyenv/bin:$PATH\"",
        "eval \"$(anyenv init -)\"",
        "echo 'Installing the pyenvs'",
        "/bin/su -l op -c 'anyenv install pyenv'",
        "echo 'Installing the nodenvs'",
        "/bin/su -l op -c 'anyenv install nodenv'", 
        "echo 'Installing the rbenvs'",
        "/bin/su -l op -c 'anyenv install rbenv'", 
        "echo 'Installing the phpenvs'",
        "/bin/su -l op -c 'anyenv install phpenv'", 
        "echo 'Installing the goenvs'",
        "/bin/su -l op -c 'anyenv install goenv'", 
        "echo 'Installing Anyenv Init'",
        "mkdir -p $(anyenv root)/plugins",
        "git clone https://github.com/znz/anyenv-update.git $(anyenv root)/plugins/anyenv-update",
        "echo 'Updating anyenv'",
        "anyenv update",
        "echo 'Installing Go'",
        "/bin/su -l op -c 'goenv install 1.21.1 && goenv global 1.21.1 && goenv rehash'",
        "echo 'Installing Node'",
        "/bin/su -l op -c 'nodenv install 20.3.0 && nodenv global 20.3.0 && nodenv rehash'",
        "echo 'Installing Python'",
        "/bin/su -l op -c 'pyenv install 3.9.18 && pyenv global 3.9.18 && pyenv rehash'",
        "echo 'Installing Ruby'",
        "/bin/su -l op -c 'rbenv install 3.2.2 && rbenv global 3.2.2 && rbenv rehash'",
        "echo 'Installing Rust'",
        "/bin/su -l op -c 'curl https://sh.rustup.rs -sSf | sh -s -- -y'",
        "echo 'Sourcing Cargo env'",
        ". '/home/op/.cargo/env'",
        "echo 'Installing x8'",
        "cargo install x8"
      ], "inline_shebang": "/bin/sh -x",
	  "type": "shell"
    }
  ]
}
